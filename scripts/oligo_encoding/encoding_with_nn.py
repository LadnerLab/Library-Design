#!/usr/bin/env python3
import h2o      # For running models
import argparse # for parsing command-line args
import pandas   # reading csv
import sys

def main():
    arg_parser = argparse.ArgumentParser( description = "Use h2o to select encodings for oligos." )  

    arg_parser.add_argument( '-m', '--model', help = "Trained model that ill be used to predict bindings" )
    arg_parser.add_argument( '-r', '--ratio_file', help = "File containing output produced by oligo_encoding script." )
    arg_parser.add_argument( '-n', '--nn_subset_size', help = "The nn_subset_size number of encodings will be output that "
                                                              "have the smallest nn deviation",
                             default = 3
                           )
    arg_parser.add_argument( '-o', '--out_file', help = "File to write final encodings out to." )
    arg_parser.add_argument( '-s', '--sequences', help = "File to read sequences generated by the oligo_encoding script" )

    args = arg_parser.parse_args()

    h2o.init()

    loaded_model = h2o.load_model( args.model )

    generated_sequences      = read_seq_file( args.sequences )
    ratio_with_labelled_cols = read_ratio_and_label( args.ratio_file )

    predictions = loaded_model.predict( h2o.H2OFrame( ratio_with_labelled_cols ) )

    generated_sequences[ 'predicted' ]     = predictions.as_data_frame()
    generated_sequences[ 'predicted_dev' ] = predictions.abs().as_data_frame()

    best_encodings = get_n_best_encodings( generated_sequences, 'AA Peptide', args.nn_subset_size )

    write_output( best_encodings, args.out_file )

def write_output( encodings, outfile_name ):
    encodings.to_csv( outfile_name, index = False )

def get_n_best_encodings( seqs_dataframe, key, n ):
    out_frame = pandas.DataFrame()
    unique_seqs = get_unique_seqs( seqs_dataframe, key )
    for seq_id in unique_seqs:
        relevant_data = seqs_dataframe[ seqs_dataframe[ key ].str.contains( seq_id ) ]
        sorted_data   = relevant_data.sort_values( 'predicted_dev' )
        out_frame     = out_frame.append( sorted_data.iloc[ 0:n ] )
    return out_frame

def get_unique_seqs( dataframe, key ):
    return set( dataframe[ key ] )
def read_ratio_and_label( filename ):
    parsed_file = pandas.read_csv( filename )

    parsed_file.columns = [ "C" + str( item ) for item in range( 1442,1530 ) ]

    return parsed_file

def read_seq_file( filename ):
    parsed_file = pandas.read_csv( filename )
    parsed_file.columns = [ "Seq ID", "AA Peptide", "Nucleotide Encoding",
                            "GC Ratio", "GC Dev (abs)"
                          ]

    return parsed_file


if __name__ == '__main__':
    main()
