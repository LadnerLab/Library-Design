# PepSeq Library Design and Encoding Pipeline 

## Introduction 
This article outlines the steps necessary to transform a FASTA file containing 
target proteins into a set of encoded probes that are ready for synthesis.
A list of necessary software is provided, and example commands are given. 
For further usage information for the linked software, we refer the reader to that software's 
help information. 

Please bear in mind that these steps are for a typical design pipeline, and will likely vary between different designs.
However, these steps should still be a useful starting point. 

## Software Used 

**Alignment-Based Clusters**:

- Muscle 3.8.31 
- Usearch 10.0.240
- [lib_naive.py](../lib_naive.py)


**Kmer-Based Clusters**

- C-KmerOligo, latest from [GitHub](https://github.com/LadnerLab/C-KmerOligo).

**General**
- [remove_duplicates](https://github.com/LadnerLab/Miscellaneous/blob/master/fastas/remove_duplicates.py)


## Creating the initial set of clusters

Using Usearch version 10.0.240, clusters containing the input sequences should be made.
A command to do this is:
```
usearch -cluster_fast seqs.fasta -id 0.5 -sort length -clusters out_dir/
```

This will populate ```out_dir``` with the clusters that are generated by 
usearch, one cluster per file. 
These clusters are then run through the design steps outlined before. 


## Kmer or Sliding Window
Typically, a threshold will be set to determine which clusters will be 
designed using either the Kmer-Based (KB) or sliding-window (SW) approaches.
We have empirically found that clusers with >= 15 sequences should be designed 
using the KB approach, and clusters with < 15 sequences should be designed with the SW approach.

## Preparing Sliding-Window Clusters
For the smaller cluster sizes, the sliding-window (with gap-spanning) approach typically results
in the fewest number of output oligos.
Before the [lib_naive](../lib_naive.py) script may be used to design oligos from these sequences, 
an alignment must be made. 

### Generating alignments
Muscle v3.8.31 is used to generate the alignments. 
For each of the clusters with fewer than 15 sequences, the following should be done:

```
muscle -in input_file_path -out output_file_path
```

### Generating the Sliding-Window Designs
Once the alignments have been made, [lib_naive](../lib_naive.py) should be used to 
create designs from the aligned clusters. 
For each of the clusters with fewer than 15 sequences, the following should be done:
```
lib_naive.py -q input_file -w 30 -s 22 -o output_file
```

Information on the parameters provided to this script can be found by running:
```
lib_naive.py --help
```

## Preparing Kmer-Based Clusters
The kmer-based design script, [kmer_oligo](https://github.com/LadnerLab/C-KmerOligo),
is used to create kmer-based designs for the clusters with >= 15 sequences. 
For each of these clusters, the following should be run:
```
kmer_oligo -q input -y 30 -x 9 -o output
```


## Combining Clusters
Once all of the designs have been created, there should be one design file for 
each cluster. 
These files must then be combined into a single combined file. 
This is typically done with:
```
awk 1 path_to_designed_files >> combined_design.fasta
```

This command will generate a single file containing all of the probes that were designed by 
both of the design methods.

## Removing Duplicates
For sufficiently large sets of input sequences, the above pipeline will generate 
duplicate oligos, which should be removed.
The script [remove_duplicates](https://github.com/LadnerLab/Miscellaneous/blob/master/fastas/remove_duplicates.py) 
was designed to perform this task. It is important to be aware that this script will
assign any of the names a duplicate probe was associated with in a non-deterministic manner.

Completion of the above steps coupled with the extensive validation of the design results in a 
set of probes that are ready to go through the encoding pipeline.


# Pre-Encoding Cluster Prep
## Introduction 

Before beginning an encoding run, clusters need to be designed by a combination of the sliding-window and 
kmer-based approaches.
Each of the following steps assume you have one FASTA file containing all of the 
**unique** probes in the design.
Additionally, the installation steps performed in the general [README](README.md) should also have been 
performed.

These steps will result in the translation of the AA probes into NT probes that are ready for synthesis.

## Software Used 
- h20 version 3.20.0.8 **must** be used, as the model is not compatible with other versions of h20.
- Any of the software found in [this repository](https://github.com/LadnerLab/Library-Design/tree/master/scripts/oligo_encoding)


## Steps
1. **Translate the FASTA File Into an Encodable Format**:
 The encoding script uses the sequences in the FASTA file containing the probes that are ready for design.
However, the encoding script takes files that are in ```csv``` format, whose lines may not exceed 
```128``` characters in length.
Because of this limitation, the input FASTA file must be transformed to fit the required format.

 The [fasta_to_encodable](fasta_to_encodable.py) script is used to perform this transformation. 
 The script will rename the input sequences to match the form ```PREFIX_NUMBER``` where 
 ```PREFIX``` is short name for the design, such as ```PV1```, and ```NUMBER``` is the 
 numeric index of this specific probe within the library. This script outputs a CSV whose lines contain
 ```PREFIX_COUNT,PROBE``` for each ```PROBE``` in the input. 
 Additionally, a ```tsv``` map is generated that maps the name of each input probe to its corresponding 
 name in the output ```csv``` produced by [fasta_to_encodable](fasta_to_encodable.py).

2. Perform the steps outlined in [this README](https://github.com/LadnerLab/Library-Design/tree/master/scripts/oligo_encoding). 
These instructions provide all of the details necessary to encode the designed probes.
